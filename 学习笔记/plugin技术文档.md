# 1 背景及意义

## 1.1 背景

在开发过程中至完成后，需要将静态图片上传至阿里云 OSS。本插件旨在实现打包时统一上传这些图片，以优化开发和部署流程。

## 1.2 作用

该插件的主要作用是简化开发流程。开发阶段，图片可以先存储在本地，便于修改和测试。如果在开发阶段就将图片上传，每次修改图片后都需重新上传，增加了开发的复杂度。因此，开发完成后再统一上传图片，可以简化上传流程，提高开发效率。

## 1.3 解决的痛点

以下是将大于 3KB 的图片上传至阿里云 OSS 再获取的好处：

- 提高图片加载速度，阿里云 OSS 可以结合 CDN（内容分发网络）服务使用。CDN 可以将图片缓存到全球各地的边缘节点，使用户可以从最近的节点获取图片，大幅度提高图片加载速度，改善用户体验。

- 减少服务器负载，当图片存储在 OSS 中时，图片的请求会由阿里云的 CDN 网络处理，而不是由应用服务器处理。这将大大减少应用服务器的负载，使其专注于处理应用逻辑和用户请求，提高性能和响应速度。

- 节省带宽，使用 OSS 存储图片可以减少应用服务器的带宽消耗，因为图片请求直接通过 OSS 和 CDN 处理。对小程序后续高流量的情况，可以节省大量的带宽成本。

- 确保图片正常访问，阿里云 OSS 提供了高可用性和可靠性的存储解决方案，确保图片数据的持久性和安全性。即使应用服务器出现故障，存储在 OSS 中的图片依然可以正常访问。

# 2 流程概要描述

![alt text](技术路线-4.png)

插件实现概要流程：

（1）枚举引用 assets/images 的写法类型。

（2）遍历引用 assets/images 的文件，然后找到导入语句和调用语句、判断图片大小是否超过 3KB，若不满足上述条件，进入（4）。

（3）符合要求的图片上传至阿里云 OSS，并将路径替换成域名路径，实现从阿里云 OSS 获取图片的目的。

（4）继续遍历文件，若未遍历完毕，重复（2）和（3），直至文件遍历完毕。

# 3 流程详细描述

## 3.1 枚举静态文件引用的写法类型

枚举引用静态文件（ src/images ）的写法类型。确定项目中存在几种引用静态文件的写法，并将其用数组进行枚举。

目前的图片类型有：
.png
.jpg
.svg

目前的写法有：

> 注意：有的文件只定义了路径，并没有调用。需要找到的是定义并调用的文件

（1） scss 写法

定义方式

```scss
$images: "../../assets/images";
$images: "../../../assets/images";
$images: "../../../../assets/images";
$images: "../../../../../assets/images";
```

目前 scss 文件调用的属性都是 `background-image`

```scss
background-image: url("#{$images}/xxx.图片类型");
```

（2） tsx 写法

第一种

定义方式

```tsx
import xxx from "@assets/images/xxx.图片类型";
```

引用方式

```tsx
<img src={xxx} />
```

第二种

直接使用方式

```tsx
<img src={require('../../../assets/images/xxx.图片类型')}>
```

（3）ts 写法

定义方式

```ts
import xxx from "@assets/images/bank/xxx.图片类型";
```

引用方式

```ts
icon: xxx,
```

---

按照上述类型，定义正则表达式匹配导入语句和调用语句

**关于 scss：**

判断 scss 文件是否导入：定义正则表达式匹配导入语句 `scssRegex`

判断 scss 文件是否调用：定义正则表达式匹配调用语句 `scssIsUsed`

**关于 tsx：**

第一种：

判断 tsx 文件是否导入：定义正则表达式匹配导入语句 `tsxRegex`，捕获导入的名称 `importName`

判断 tsx 文件是否调用：判断 `importName` 是否在文件中被使用 `tsxIsUsed`

第二种：

定义正则表达式判断是否直接导入并调用 `tsxRequire`

**关于 ts：**

和 tsx 的第一种方法一致 `tsRegex` `importName` `tsIsUsed`

## 3.2 遍历引用静态文件的文件夹

使用 Node.js 的文件系统模块（fs）编写一个脚本，递归遍历遍历引用静态文件的文件夹，目前引用静态文件的文件夹有 src/components 、 src/package\*（package 开头的文件夹）和 src/pages 。

查找并记录所有导入静态文件的文件，用数组进行保存，数组分别命名为 `scss/tsx/tsFiles`。

## 3.3 找到导入语句和调用语句

根据文件的内容判断是否同时满足 3.1 定义的正则表达式

## 3.4 判断文件大小是否超过 3KB

已实现

## 3.5 将该图片上传至 OSS

已实现

## 3.6 将相对路径替换成域名

使用正则表达式替换相对路径为 OSS 域名路径，将替换后的内容写回文件。

## 3.7 判断文件是否遍历完毕

根据 `scss/tsx/tsFiles` 的数组长度判断是否遍历完毕。
